---
title: "Module 2: Hands-on with pharmacogenomics data"
author:
  - name: Jermiah J. Joseph
    email: jermiah.joseph@uhn.ca
    affiliation:
        - &pm Princess Margaret Cancer Centre
  - name: Almas Khan
    email: almas.khan@mail.utoronto.ca
    affiliation:
        - &pm Princess Margaret Cancer Centre
  - name: Julia Nguyen
    email: julia.nguyen@uhn.ca
    affiliation:
        - &pm Princess Margaret Cancer Centre
output: 
  BiocStyle::html_document:
    self_contained: yes
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: show
date: "`r doc_date()`"
package: "`r pkg_ver('CBWWorkshop2024')`"
vignette: >
  %\VignetteIndexEntry{Module 2: Hands-on with pharmacogenomics data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE} 
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r eval=TRUE, echo=FALSE}
PGx <- BiocStyle::Biocpkg("PharmacoGx")
CGx <- BiocStyle::Biocpkg("CoreGx")
TGx <- BiocStyle::Biocpkg("ToxicoGx")
RGx <- BiocStyle::Biocpkg("RadioGx")
Xv <- BiocStyle::Biocpkg("Xeva")
DT <- BiocStyle::CRANpkg("data.table")
SE <- BiocStyle::Biocpkg("SummarizedExperiment")
MAE <- BiocStyle::Biocpkg("MultiAssayExperiment")
```


# Lab 2 Overview {-}

## Instructor(s) name(s) and contact information {-}

* Jermiah J. Joseph <jermiah.joseph@uhn.ca>
* ALMAS_ DETAILS

## Lab Description {-}

<!-- Lab Practical â€“ Hands-on with pharmacogenomics data  (Jermiah Joseph, Almas Khan)

Loading a PharmacoSet in R using PharmacoGx or ORCESTRA, understanding the data structure, accessing features, and preparing metadata
Plot batch effects using PCA and run correction method (SVA)
Filter out outliers and missing values -->

### Learning goals {-}

* Understand the data structure of a PharmacoSet
* Learn how to access features and metadata from a PharmacoSet
* Learn how to plot batch effects using PCA and run correction method (SVA)
* Learn how to filter out outliers and missing values

### Learning objectives {-}

* Describe the use cases for `r PGx` in Pharmacogenomics
* Understand the structure of the `CoreSet` and `PharmacoSet` classes to facilitate their use in subsequent analyses
* Download/load a `PharmacoSet` using `r PGx` or [orcestra.ca](https://orcestra.ca)
* Subset and filter a `PharmacoSet` by samples and/or treatments
* Access the molecular features, dose-response and metadata contained within the `PharmacoSet`

----

```{r global_knitr_opts, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE, message = TRUE)
```

```{r load_packages, eval=TRUE, echo=FALSE, include=FALSE}
suppressPackageStartupMessages({
  library(CBWWorkshop2024)
  library(PharmacoGx)
  library(data.table)
})
```


# Getting Started

## Use Cases for `r PGx`

*Downloading Data from [orcestra.ca](https://orcestra.ca)

```{r get_avail_psets}
available <- PharmacoGx::availablePSets() |>
  data.table::as.data.table()

print(names(available))

print(available[, c("Dataset Name", "PSet Name", "version")])
```

The following function from `r PGx` can be used to download any of the available PSets from [orcestra.ca](https://orcestra.ca).

The command to do so is:
`PharmacoGx::downloadPSet(name="CCLE_2015",saveDir = "../psets", timeout = 3600, verbose = T)`

For convenience and in the interest of time, we have created a `PharmacoSet` to be used 
in this tutorial. We will be interacting with this dataset for the remainder of the tutorial.

```{r load_pset}
data(NCI_ALMANAC_pset)
NCI_ALMANAC_pset
```

## Understanding the Data Structure

The `PharmacoSet` class is a container for pharmacogenomic data. 

This pharmacogenomic data is typically generated from high-throughput
screening experiments where cell lines are treated with a panel of drugs at multiple doses and the response is measured using a molecular assay.


```{r show_pset_structure}
slotNames(NCI_ALMANAC_pset)
```

### View the `sample`s 

We can access the `sampleNames` of the `PharmacoSet`:

```{r show_sample_names}
PharmacoGx::sampleNames(NCI_ALMANAC_pset)
```

To get all the metadata associated with the samples, we can access the `sample` slot:
```{r show_samples}
NCI_ALMANAC_pset@sample |> str()
```


We can see from the `sample` slot that there are 60 samples in this `PharmacoSet`.

### View the `treatment`s

Similar to the `sample`s, we can access the `treatmentNames` of the `PharmacoSet`:

```{r show_treatment_names}
PharmacoGx::treatmentNames(NCI_ALMANAC_pset) |> head()
```

To get all the metadata associated with the treatments, we can access the `treatment` slot:

```{r show_treatments}
NCI_ALMANAC_pset@treatment |> str()
```
There are also 31 treatments used.


### Subset by `sampleNames` and/or `treatmentNames`

```{r subset_pset}
PharmacoGx::subsetBySample(
  NCI_ALMANAC_pset,
  sample = sampleNames(NCI_ALMANAC_pset)[1:5]
)

PharmacoGx::subsetByTreatment(
  NCI_ALMANAC_pset,
  treatment = treatmentNames(NCI_ALMANAC_pset)[1:5]
)
```


### Subsetting using `sample` and `treatment` metadata

```{r subset_pset_metadata, warning=FALSE}
unique(NCI_ALMANAC_pset@sample$tissueid)

tissues_of_interest <- c("Kidney")
indices <- which(NCI_ALMANAC_pset@sample$tissueid %in% tissues_of_interest)


(samples_of_interest <- sampleNames(NCI_ALMANAC_pset)[indices])

PharmacoGx::subsetBySample(
  NCI_ALMANAC_pset,
)
```
A concise way to subset by `sample` in one step:

```{r subset_pset_metadata2, warning=FALSE}
PharmacoGx::subsetBySample(
  NCI_ALMANAC_pset,
  sample = NCI_ALMANAC_pset@sample[
    NCI_ALMANAC_pset@sample$tissueid == "Kidney",
    "sampleid"
  ]
)
```














